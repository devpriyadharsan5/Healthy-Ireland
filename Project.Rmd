

```{r}
suppressWarnings(library(haven))
suppressWarnings(library(dplyr))
suppressWarnings(library(magrittr))
suppressWarnings(library(knitr))
suppressWarnings(library(lattice))
suppressWarnings(library(tidyverse))
suppressWarnings(library(likert))
suppressWarnings(library(MASS))
suppressWarnings(library(psych))
suppressWarnings(library(viridis))
suppressWarnings(library(ggplot2))
suppressWarnings(library(here))
suppressWarnings(library(flextable))
suppressWarnings(library(devtools))
suppressWarnings(library(dplyr))
suppressWarnings(library(labelled))
suppressWarnings(library(foreign))
suppressWarnings(library(questionr))
suppressWarnings(library(survey))
suppressWarnings(library(tibble))
suppressWarnings(library(psych)) #masks ggpplot2:: %+%, alpha
suppressWarnings(library(GGally)) #masks dbplyr::nasa
suppressWarnings(library(kableExtra)) #masks dplyr::group_rows
suppressWarnings(library(MVN))
suppressWarnings(library(likert))
suppressWarnings(library(plyr))
```


```{r}
library(haven)
data <- read_sav("0021-04_healthy_ireland_2018.sav")
#View(data)
```


```{r}
df1 <- data[c("q6","q7","q8","slq9b","q10","q11","q13","q340","q348","q349")]

df2 <- data[c("q14","exq15","exq18")]

df3 <- data[c("spq1","q52","q55","q58","q120","q205","q208","q308")]

df4 <- data[c("q229","q230","q231","q232","q233","q330_1","q330_2","q330_3")]

df5 <- data[c("q63b","lho","key1","ageclass","countbirth")]
```



```{r}
table(newdata$q6, exclude = NULL)

table(newdata$q7, exclude = NULL)
```

```{r}
#write.table(df1, file = "df1.csv",sep = "\t", row.names = F)

#write_sav(df1, "df1.sav")  

newdata <- cbind(df1, df2,df3,df4,df5) 

#n <- cbind(df1new, df2new,df3,df4,df5) 

#write_sav(newdata, "newdata.sav") 

```



```{r}
look_for(df2)

#df1$q6 %>% "c('haven_labelled', 'vctrs_vctr', 'double')"
```

```{r}
val_labels(df2) #gives options
```


```{r}
var_label(df2) #gives questions
```

```{r}
glimpse(df2)
```


```{r}
# Continuous variables
summary(df2)
```


```{r}
#always use n1

n1<- to_factor((newdata), drop_unused_labels=TRUE, ordered=TRUE)

table(n1$q6,exclude = NULL)
```

```{r}
table(n1$q7,exclude = NULL)
```

```{r}
barplot(table(n1$q52, n1$ageclass, exclude = NULL))
```

```{r}
#proportions

ggplot(data = n1) +
  geom_bar(mapping = aes(x = ageclass, fill=q52) , position = "fill") +
  scale_fill_brewer(palette="Paired")+
  theme_minimal()
table(data$ageclass )
table(data$agecls2 )
table(data$agecls3 )


n1 %>% dplyr::count(ageclass)
```


```{r}

n1|> group_by(ageclass) |> 
  dplyr::summarise(N=n(),q6=q6) |> 
  group_by(ageclass,q6) |> 
  dplyr::summarise(n(),N = N)


n1|> group_by(ageclass,q6) |> 
  dplyr::summarise(count=n()) |> 
  ungroup() |> group_by(ageclass) |> 
  dplyr::summarise(perc=count/sum(count)*100)

ggplot(data = n1) +
  geom_bar(mapping = aes(x = ageclass, fill=q6)) 

```


```{r}
ggplot(data = n1,na.rm=TRUE) +
  geom_bar(aes(x = ageclass, fill=q6), position="dodge") +
  scale_fill_manual(values=c("#B6300C",
                             "#20A220",
                             "#2C8EE5"))+
  scale_fill_discrete(name = "Do you smoke tobacco products?")+
  facet_wrap(~q52) 
 
```


```{r}
ggplot(n1, aes(x=q6, fill=n1$q52))+
  geom_bar(position="fill")
```


```{r}
d1= n1|> group_by(q6,q52) |> 
  dplyr::summarise(count=n()) |> 
  ungroup() |> group_by(q6) |> 
  dplyr::summarise(perc=count/sum(count)*100, q52=q52) |>
  drop_na()

# Combine "Yes, daily" with "Yes, occasionally"
n1$q6 <- ifelse(n1$q6 %in% c("Yes, daily", "Yes, occasionally"), "Yes", "No")

# Calculate percentage of smokers by age
smoking_by_age <- d1 %>%
  group_by(ageclass, q6) %>%
  dplyr::summarise(count=n()) |>
  ungroup() |>
  group_by(ageclass) %>%
  dplyr::mutate(perc=count/sum(count)*100) %>%
  filter(q6 == "Yes") %>%
  dplyr::arrange(ageclass)

# Plot the results
ggplot(smoking_by_age, aes(x=ageclass, y=perc, fill=q6)) +
  geom_bar(stat="identity", position="dodge") +
  scale_fill_discrete(name = "Do you smoke tobacco products?") +
  labs(title="Percentage of the population that smokes, by age",
       x="Age",
       y="Percentage")

```



```{r}
library(haven)
library(dplyr)
library(ggplot2)



s <- n1 %>% 
  dplyr::group_by(q6, ageclass) %>% 
  dplyr::summarise(count = n()) |>
  drop_na() |>
  ungroup() %>%
  group_by(ageclass) %>%
  dplyr::mutate(perc = count/sum(count)*100) %>%
  dplyr::select(ageclass, q6, count, perc)

# Recode smoking variable to combine "Yes, daily" and "Yes, occasionally"
s$q6 <- ifelse(s$q6 %in% c("Yes, daily", "Yes, occasionally"), "Yes", "No")

# Group by ageclass and smoking status, and summarize the count of individuals in each group
smoking_by_age <- s %>% 
  group_by(ageclass, q6) %>% 
  dplyr::summarise(count = n())

# Calculate the percentage of individuals in each group
smoking_by_age <- 
  smoking_by_age %>% 
  group_by(ageclass) %>% 
  mutate(perc = count/sum(count)*100)

# Plot the results
ggplot(s, aes(x = ageclass, y = perc, fill = q6)) +
  geom_bar(stat = "identity", position = "dodge") +
  labs(x = "Age", y = "Percentage of population", fill = "Smoking status") +
  ggtitle("Smoking by Age") +
  theme(plot.title = element_text(hjust = 0.5))

```



##1. What percentage of the population smokes and how does this vary by age

```{r}

d1 <- mutate(n1, smoker = ifelse(q6 == "Yes, daily" | q6 == "Yes, occasionally", "Yes", "No"))



n2= n1|> group_by(ageclass,d1) |> 
  dplyr::summarise(count=n()) |> 
  ungroup() |> group_by(ageclass) |> 
  dplyr::summarise(perc=count/sum(count)*100, q6=q6) |>
  drop_na()


ggplot(n2, aes(x=ageclass, y = perc, fill =d1)) + 
  geom_bar(stat="identity", position="dodge")+
  scale_fill_discrete(name = "Do you smoke tobacco products?")



# This will create a bar chart that shows the percentage of people who smoke and do not smoke, by age group.

# More than 75% of the people from all age categories doesn't smoke.

```

```{r}

```

```{r}
n33= n1|> group_by(q6,q52) |> 
  dplyr::summarise(count=n()) |> 
  ungroup() |> group_by(q6) |> 
  dplyr::summarise(perc=count/sum(count)*100, q52=q52) |>
  drop_na()


ggplot(n33, aes(x=q52, y = perc, fill =q6)) + 
  geom_bar(stat="identity", position="dodge")+
  scale_fill_discrete(name = "Do you smoke tobacco products?")
```




```{r}
# Select the required variables
df_smoking <- n1[c("q6", "q52")]

# Group the data by smoking and gender, and count the number of observations in each group
grouped_data <- df_smoking |>
  group_by(q6, q52) |>
  dplyr::summarise(count = n()) |>
  ungroup()

# Calculate the total number of observations (excluding missing values)
total_obs <- sum(grouped_data$count)

# Calculate the percentage of the population that smokes, by gender
smoking_perc <- grouped_data |>
  mutate(perc = count / total_obs * 100) 

# Plot the results
library(ggplot2)

ggplot(smoking_perc, aes(x = q52, y = perc, fill = q6)) +
  geom_bar(stat = "identity", position = "dodge") +
  labs(x = "Gender", y = "Percentage", fill = "Smoking") +
  ggtitle("Percentage of population that smokes, by gender")
```


```{r}
n22 <- n1 |>
  group_by(key1, q6) %>%
  dplyr::summarise(count = n()) %>%
  ungroup() %>%
  group_by(key1) %>%
  mutate(perc = count / sum(count) * 100) 

ggplot(n22, aes(x = key1, y = perc,fill = q6)) +
  geom_bar(stat = "identity",position = "dodge") +
    
  scale_x_discrete(labels = function(x) 
    stringr::str_wrap(x, width = 25))+
  labs(x = "Socioeconomic Status", y = "Percentage of smokers") +
  theme(axis.text.x = element_text(angle = 90,hjust=1))+
  ggtitle("Smoking prevalence by socioeconomic status")

```



```{r}
d1|>dplyr::select(q6, ageclass)
```

